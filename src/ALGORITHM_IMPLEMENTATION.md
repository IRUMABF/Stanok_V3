# Реалізація алгоритму роботи станка

## Загальна структура

Код реалізовано відповідно до алгоритму з файлу `algoritm.md` з додаванням логіки управління конвеєром та датчиками.

## Основні компоненти

### 1. Змінні стану
- `jarCounter` - лічильник баночок (0-5)
- `spiceSetCounter` - лічильник спайок (0-3, потрібно 4)
- `waitingForSensorX` - флаги очікування спрацювання датчиків
- `paintCycleActive` - активний цикл розливу фарби
- `capCycleActive` - активний цикл закривання кришок
- `packagingCycleActive` - активний цикл пакування

### 2. Цикли роботи

#### Цикл розливу фарби (кроки 1-4)
1. **Відкриття крану фарби** (`commandPaintValveOpen`)
   - Перевіряє датчик 1 (баночка під соплом)
   - Включає клапан 2 (розподілювач №2)

2. **Забор фарби поршнем** (`commandPaintPistonIntake`)
   - Перевіряє датчик 1
   - Включає клапан 3 (розподілювач №3)

3. **Закриття крану фарби** (`commandPaintValveClose`)
   - Виключає клапан 2

4. **Видача фарби поршнем** (`commandPaintPistonDispense`)
   - Перевіряє датчик 1
   - Виключає клапан 3

#### Цикл закривання кришок (кроки 5-6)
1. **Завертання кришок** (`commandCapScrew`)
   - Перевіряє датчик 2 (баночка під пресом)
   - Включає клапан 4 (розподілювач №4)

2. **Закривання кришок** (`commandCapClose`)
   - Перевіряє датчик 2
   - Включає клапан 5 (розподілювач №5)

#### Цикл пакування (кроки 7-29)
1. **Зсування спайки** (`commandSpiceShift`)
   - Включає клапан 6 (розподілювач №6)

2. **Пересування платформи** (кроки 8-15)
   - Домашнє положення, опускання, вакуум, піднімання
   - Переміщення з пакетом, опускання над пакетом

3. **Запихання спайок** (кроки 16-29)
   - Засування в пакет, утримання, вакуум, запайка
   - Охолодження, повернення механізмів

## Логіка роботи з датчиками

### Датчик 1 (sensor_1)
- **Призначення**: Баночка під соплом розливу фарби
- **Дія**: Зупиняє конвеєр, просуває на `JAR_CENTERING_MM` мм, запускає цикл розливу
- **Режими**: 
  - `dispenseMode = false`: тільки перша баночка
  - `dispenseMode = true`: всі 6 баночок

### Датчик 2 (sensor_2)
- **Призначення**: Баночка під пресом закривання кришки
- **Дія**: Зупиняє конвеєр, запускає цикл закривання кришок
- **Особливість**: Завжди обробляє тільки першу баночку з збірки

### Датчик 3 (sensor_3)
- **Призначення**: Спайка готова до зсування
- **Дія**: Зупиняє конвеєр, збільшує лічильник спайок
- **Логіка**: Після 4 спайок запускає повний цикл пакування

## Управління конвеєром

### Автоматичний режим
- Конвеєр працює постійно
- Зупиняється при спрацюванні датчиків
- Запускається після завершення циклів

### Режим паузи
- Конвеєр зупиняється
- Всі цикли заморожуються
- Таймери залишаються в поточному стані

## Кнопки управління

### START
- Запускає машину
- Скидає всі лічильники та стани
- Включає конвеєр

### STOP
- Зупиняє машину
- Вимикає конвеєр
- Зупиняє всі активні цикли

### MODE
- Перемикає режим розливу
- `false`: тільки перша баночка
- `true`: всі баночки

### SINGLE BLOCK
- Включає режим поетапного виконання
- Кожне натискання START виконує один крок
- Корисно для відладки

## Особливості реалізації

### Без delay()
- Використовується `millis()` для таймерів
- Конвеєр та датчики працюють паралельно з пневматикою

### Управління клапанами
- Кожен клапан має свій об'єкт `PneumaticValve`
- Підтримуються команди `on()`, `off()`, `onFor()`, `offFor()`

### Відладка
- Три рівні деталізації (DEBUG_LEVEL 0-2)
- Детальна інформація про стан всіх компонентів
- Логування всіх операцій

## Послідовність роботи

1. **Запуск**: Натискання START
2. **Очікування**: Конвеєр рухається, очікує спрацювання датчиків
3. **Цикл розливу**: При спрацюванні датчика 1
4. **Цикл кришок**: При спрацюванні датчика 2
5. **Збір спайок**: При спрацюванні датчика 3 (до 4 штук)
6. **Цикл пакування**: Після збору 4 спайок
7. **Повторення**: Повернення до кроку 1

## Безпека

- Перевірка стану датчиків перед виконанням команд
- Зупинка конвеєра під час операцій
- Можливість екстреної зупинки кнопкою STOP
- Логування всіх помилок та попереджень
