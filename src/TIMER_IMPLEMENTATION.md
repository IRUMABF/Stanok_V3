# РЕАЛІЗАЦІЯ ТАЙМЕРІВ У PNEVMATIK_TIME.H

## Огляд

Файл `pnevmatik_time.h` було повністю оновлено відповідно до логіки роботи з `main.cpp`. Додано всі необхідні змінні таймерів та оптимізовано їх під алгоритм роботи машини.

## Основні зміни

### 1. Структура таймерів

Файл тепер має чітку структуру з розділами:
- **Видача спайок** - таймери для клапана 1
- **Цикл розливу фарби** - таймери для клапанів 2-3
- **Цикл закривання кришок** - таймери для клапанів 4-5
- **Зсування спайки** - таймери для клапана 6
- **Цикл пакування** - таймери для клапанів 7-14
- **Додаткові таймери** - для алгоритму роботи
- **Константи** - для логіки роботи
- **Макроси** - для зручності

### 2. Оптимізовані значення таймерів

#### Цикл розливу фарби
- `PAINT_VALVE_HOLD_TIME`: 1000ms (1 сек) - час наливу фарби
- `PAINT_PISTON_IN_HOLD_TIME`: 800ms - час забору фарби
- `PAINT_PISTON_OUT_HOLD_TIME`: 1000ms (1 сек) - час видачі фарби

#### Цикл закривання кришок
- `TWIST_CAP_HOLD_TIME`: 800ms - час завертання кришок
- `CLOSE_CAP_HOLD_TIME`: 1000ms (1 сек) - час закривання кришок

#### Цикл пакування
- `PLATFORM_MOVE_HOLD_TIME`: 600ms - час переміщення платформи
- `PLATFORM_LIFT_HOLD_TIME`: 500ms - час підняття/опускання платформи
- `SPICE_PUSH_HOLD_TIME`: 600ms - час засування спайок
- `SILICONE_BAR_HOLD_TIME`: 800ms - час роботи силіконової планки

### 3. Нові додаткові таймери

#### Таймери для циклів роботи
- `PAINT_CYCLE_TOTAL_TIME`: 5000ms (5 сек) - загальний час циклу розливу
- `CAP_CYCLE_TOTAL_TIME`: 3000ms (3 сек) - загальний час циклу закривання
- `PACKAGING_CYCLE_TOTAL_TIME`: 15000ms (15 сек) - загальний час пакування

#### Таймери для датчиків
- `SENSOR_DEBOUNCE_TIME`: 50ms - час стабілізації датчика
- `SENSOR_TIMEOUT_TIME`: 10000ms (10 сек) - таймаут очікування

#### Таймери для конвеєра
- `CONVEYOR_START_DELAY`: 200ms - затримка запуску
- `CONVEYOR_STOP_DELAY`: 100ms - затримка зупинки
- `CONVEYOR_OVERRUN_TIME`: 1000ms (1 сек) - додатковий рух

#### Таймери для вакууму
- `VACUUM_BUILD_TIME`: 1000ms (1 сек) - час створення вакууму
- `VACUUM_HOLD_TIME`: 2000ms (2 сек) - час утримання вакууму
- `VACUUM_RELEASE_TIME`: 500ms - час скидання вакууму

#### Таймери для нагріву та охолодження
- `HEATER_WARMUP_TIME`: 3000ms (3 сек) - прогрів нагрівача
- `HEATER_ACTIVE_TIME`: 2000ms (2 сек) - активний нагрів
- `COOLER_ACTIVE_TIME`: 3000ms (3 сек) - активне охолодження

### 4. Константи для логіки роботи

- `JARS_IN_SET`: 6 - кількість баночок у збірці
- `SPICE_SETS_PER_PACKAGE`: 4 - кількість спайок на пакет
- `DISPENSE_MODE_ALL`: 1 - розлив усіх баночок
- `DISPENSE_MODE_ONE`: 0 - розлив лише першої баночки

### 5. Макроси для зручності

- `SECONDS_TO_MS(seconds)` - перетворення секунд в мілісекунди
- `MS_TO_SECONDS(ms)` - перетворення мілісекунд в секунди
- `IS_TIMEOUT(start_time, timeout)` - перевірка таймауту
- `IS_INTERVAL(start_time, interval)` - перевірка інтервалу

## Інтеграція з main.cpp

### 1. Оновлені функції команд

Всі функції команд тепер використовують:
- `onFor()` та `offFor()` з правильними таймерами
- **НЕ використовують `delay()`** - це заборонено згідно з алгоритмом
- Виведення часу виконання в секундах

### 2. Додано таймери для циклів

- `paintCycleStartTime` - час початку циклу розливу
- `capCycleStartTime` - час початку циклу закривання
- `packagingCycleStartTime` - час початку циклу пакування

### 3. Додано таймери для датчиків

- `sensor1StartTime` - час очікування датчика 1
- `sensor2StartTime` - час очікування датчика 2

### 4. Виправлена логіка третього датчика

Згідно з алгоритмом:
- **Третій датчик НЕ обробляється окремо**
- Він спрацьовує **після успішного закривання кришок**
- Логіка обробки перенесена в цикл закривання кришок

### 5. Перевірка таймаутів

Додано автоматичну перевірку таймаутів для:
- Датчиків (10 секунд)
- Циклів розливу (5 секунд)
- Циклів закривання (3 секунди)
- Циклів пакування (15 секунд)

### 6. Автоматичне відновлення

При таймауті:
- Скидаються стани циклів
- Перезапускається конвеєр
- Виводяться попередження

## Переваги нової реалізації

1. **Точність** - всі таймери налаштовані під реальну логіку роботи
2. **Надійність** - автоматична перевірка таймаутів та відновлення
3. **Відладка** - детальна інформація про час виконання
4. **Гнучкість** - легко змінювати таймери для наладки
5. **Безпека** - запобігання зависанню машини
6. **Відповідність алгоритму** - **НЕ використовуються `delay()`**

## Важливі виправлення

### 1. Видалено всі `delay()`
- Це заборонено згідно з алгоритмом
- Всі операції виконуються через `onFor()` та `offFor()`
- Конвеєр та датчики працюють паралельно з пневматикою

### 2. Видалено непотрібні затримки
- Видалено всі `*_DELAY` константи
- Залишено тільки основні таймери для роботи клапанів

### 3. Виправлена логіка третього датчика
- Тепер спрацьовує після закривання кришок
- Не обробляється окремо
- Логіка перенесена в правильне місце

## Налаштування таймерів

Для налаштування таймерів під конкретну машину:

1. **Змініть значення** у відповідних `#define`
2. **Протестуйте** на реальній машині
3. **Налаштуйте** під швидкість роботи
4. **Перевірте** безпеку та надійність

## Приклади використання

```cpp
// Використання таймера для клапана
valve1.onFor(SPICE_OUT_HOLD_TIME);

// Перевірка таймауту
if (IS_TIMEOUT(sensor1StartTime, SENSOR_TIMEOUT_TIME)) {
    // Обробка таймауту
}

// Конвертація часу
Serial.print(MS_TO_SECONDS(PAINT_CYCLE_TOTAL_TIME));
Serial.println(" seconds");
```

## Висновок

Нова реалізація таймерів забезпечує:
- Повну відповідність алгоритму роботи
- **Відсутність `delay()`** - як вимагається
- Автоматичну обробку помилок
- Детальну відладку
- Легкість налаштування
- Надійну роботу машини
- Правильну логіку третього датчика
